require 'asciidoctor'
require 'rake/clean'
require 'rake/testtask'

OUTDIR = "public"
SOURCE = "src/index.adoc"
FONTDIR = "fonts"

CLEAN.include(OUTDIR)

Rake::TestTask.new do |test|
  test.test_files = Dir['test/**/*_test.rb']
  test.verbose = true
end

desc 'Create HTML'
task :html do
  # public/index.htmlを生成
  sh "asciidoctor -d book -o #{OUTDIR}/index.html -n #{SOURCE}"
  sh "cp -rp src/images #{OUTDIR}"
end

def copy_font(fn)
  FileUtils.mkdir_p( FONTDIR )
  return if File.exist?(File.join( FONTDIR, fn))
  %w[
    ~/Library/Fonts/
    /Library/Fonts/
  ].each do |src_dir|
    src_dir.gsub!( /^\~/, Dir.home )
    src_fn = File.join( src_dir, fn )
    p [ File.exist?(src_fn), src_fn ] if /Gen/===src_fn
    next unless File.exist?(src_fn)
    FileUtils.cp( src_fn, FONTDIR )
  end
end

MATH_FONTS = %w[
  cmex10.ttf cmmi10.ttf cmr10.ttf cmsy10.ttf
  esint10.ttf eufm10.ttf msam10.ttf msbm10.ttf
].freeze

MATHFNOT_URL = "http://mirrors.ctan.org/fonts/cm/ps-type1/bakoma/ttf/"

def download_mathfont(m)
  Dir.chdir( File.join( Dir.home, "Library/Fonts" ) ) do
    unless File.exist?(m)
      sh "curl -LO #{MATHFNOT_URL}/#{m}"
    end
  end
end


desc 'Prepare Font'
task :prepare_font do
  %w[
    GenShinGothic-P-Normal.ttf
    GenShinGothic-P-Bold.ttf
    Ricty-Regular.ttf
    Ricty-Bold.ttf
    ipaexm.ttf
  ].each do |fn|
    copy_font(fn)
  end

  MATH_FONTS.each do |m|
    download_mathfont(m)
  end
end

desc 'Create PDF'
task pdf: [:prepare_font] do
  here = File.split( __FILE__ )[0]
  prawn_linewrap_ja = File.join( here, "lib/prawn-linewrap-ja" )
  cmd = %W(
    asciidoctor-pdf
    -r #{prawn_linewrap_ja}
    -r asciidoctor-mathematical
    -r asciidoctor-diagram
    -a pdf-style=src/style/theme.yml
    #{SOURCE}
    -o #{OUTDIR}/book.pdf)
  sh cmd.join(" ")
  # sh "PLANTUML_LIMIT_SIZE=16384 asciidoctor-pdf -r asciidoctor-pdf-cjk #{SOURCE} -o #{OUTDIR}/book.pdf"
end

task :default => [:test]
